#!/usr/bin/env bash

<%-
modules = (context.modules)
wrapper = session.staged_root.join("launch_wrapper.sh")
wrapper_log = session.staged_root.join("launch_wrapper.log")
kernels = {
    python39: {
        display_name: "Python 3.9.5",
        language: "python",
        argv: [
            wrapper,
            "python",
            "-m",
            "ipykernel_launcher",
            "-f",
            "{connection_file}"
        ],
        env: {
            MODULES: "#{modules}"
        }
    }
}
-%>

echo "Starting main script..."
echo "TTT - $(date)"

#
# Start Jupyter server
#

# Clean the environment
module purge

# Create launcher wrapper
echo "Creating launcher wrapper script..."
(
umask 077
sed 's/^ \{2\}//' > "<%= wrapper %>" << EOL
  #!/usr/bin/env bash

  # Log all output from this script
  exec &>>"<%= wrapper_log %>"

  # Load the required environment
  module purge
  module load \${MODULES}
  module list

  # Launch the original command
  set -x
  exec "\${@}"
EOL
)
chmod 700 "<%= wrapper %>"
echo "TTT - $(date)"

# Setup Jupyter environment
module use $MODULEPATH_ROOT/project/ondemand
module load <%= context.modules %>
module list
echo "TTT - $(date)"

# Set working directory to notebook root directory
cd "<%- context.start_folder -%>"
echo ${PWD}

# List available kernels for debugging purposes
set -x
jupyter kernelspec list
{ set +x; } 2>/dev/null
echo "TTT - $(date)"

# Launch the Jupyter server
echo $JUPYTER_CONFIG_PATH
set -x
jupyter <%= context.jupyterlab_switch == "1" ? "lab" : "notebook" %> --config="${CONFIG_FILE}" <%= context.extra_jupyter_args %>
